<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedro's Comic Collection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .loader { border-top-color: transparent; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Supabase config
    const SUPABASE_URL = 'https://ykumllgvkhfvvgrhodue.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrdW1sbGd2a2hmdnZncmhvZHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTk5MTcsImV4cCI6MjA4NDE5NTkxN30.Oy-f0yrZrrO9NNMXMg1j4wJYhU_YQBhiIx7N5fXgx7A';

    // Supabase client
    const supabase = {
      from: (table) => ({
        select: async (columns = '*') => {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}`, {
            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
          });
          return { data: await res.json(), error: res.ok ? null : 'Error' };
        },
        insert: async (rows) => {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(rows)
          });
          return { data: await res.json(), error: res.ok ? null : 'Error' };
        },
        update: (updates) => ({
          eq: async (col, val) => {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${col}=eq.${val}`, {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
              },
              body: JSON.stringify(updates)
            });
            return { data: await res.json(), error: res.ok ? null : 'Error' };
          }
        }),
        delete: () => ({
          eq: async (col, val) => {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${col}=eq.${val}`, {
              method: 'DELETE',
              headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
            });
            return { error: res.ok ? null : 'Error' };
          }
        })
      })
    };

    function App() {
      const [activeTab, setActiveTab] = useState('overview');
      const [series, setSeries] = useState([]);
      const [issues, setIssues] = useState([]);
      const [gaps, setGaps] = useState([]);
      const [gifts, setGifts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [expanded, setExpanded] = useState({});
      const [filter, setFilter] = useState('all');
      const [showAdmin, setShowAdmin] = useState(false);
      const [adminMode, setAdminMode] = useState('add-issue');

      // Admin form states
      const [newIssue, setNewIssue] = useState({ series_id: '', issue_number: '', covers: '', status: 'pending', notes: '' });
      const [newSeries, setNewSeries] = useState({ name: '', publisher: 'DC', status: 'in-progress', total_spent: 0 });
      const [saving, setSaving] = useState(false);
      const [message, setMessage] = useState('');

      useEffect(() => { fetchData(); }, []);

      const fetchData = async () => {
        setLoading(true);
        try {
          const [seriesRes, issuesRes, gapsRes, giftsRes] = await Promise.all([
            supabase.from('series').select('*'),
            supabase.from('issues').select('*'),
            supabase.from('gaps').select('*'),
            supabase.from('gifts').select('*')
          ]);
          setSeries(seriesRes.data || []);
          setIssues(issuesRes.data || []);
          setGaps(gapsRes.data || []);
          setGifts(giftsRes.data || []);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const toggleExpand = (id) => setExpanded(p => ({ ...p, [id]: !p[id] }));

      const handleAddIssue = async (e) => {
        e.preventDefault();
        setSaving(true);
        const coversArray = newIssue.covers.split(',').map(c => c.trim()).filter(c => c);
        const { error } = await supabase.from('issues').insert({
          series_id: parseInt(newIssue.series_id),
          issue_number: newIssue.issue_number,
          covers: coversArray,
          status: newIssue.status,
          notes: newIssue.notes || null
        });
        setSaving(false);
        if (!error) {
          setMessage('Issue added!');
          setNewIssue({ series_id: '', issue_number: '', covers: '', status: 'pending', notes: '' });
          fetchData();
        } else {
          setMessage('Error adding issue');
        }
        setTimeout(() => setMessage(''), 3000);
      };

      const handleAddSeries = async (e) => {
        e.preventDefault();
        setSaving(true);
        const { error } = await supabase.from('series').insert(newSeries);
        setSaving(false);
        if (!error) {
          setMessage('Series added!');
          setNewSeries({ name: '', publisher: 'DC', status: 'in-progress', total_spent: 0 });
          fetchData();
        } else {
          setMessage('Error adding series');
        }
        setTimeout(() => setMessage(''), 3000);
      };

      const markAsOwned = async (issueId) => {
        await supabase.from('issues').update({ status: 'owned' }).eq('id', issueId);
        fetchData();
      };

      // Stats
      const totalSpent = series.reduce((sum, s) => sum + (parseFloat(s.total_spent) || 0), 0);
      const ownedBooks = issues.filter(i => i.status === 'owned').length;
      const pendingBooks = issues.filter(i => i.status === 'pending').length;
      const completeRuns = series.filter(s => s.status === 'complete').length;

      const getSeriesIssues = (seriesId) => issues.filter(i => i.series_id === seriesId);

      const StatusBadge = ({ status }) => {
        const colors = {
          'complete': 'bg-green-100 text-green-800',
          'near-complete': 'bg-yellow-100 text-yellow-800',
          'in-progress': 'bg-blue-100 text-blue-800',
          'misc': 'bg-gray-100 text-gray-800',
          'owned': 'bg-green-100 text-green-800',
          'pending': 'bg-yellow-100 text-yellow-800',
        };
        return <span className={`px-2 py-0.5 rounded text-xs font-medium ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
      };

      const filteredSeries = series.filter(s => {
        if (filter === 'all') return true;
        if (filter === 'complete') return s.status === 'complete';
        if (filter === 'in-progress') return s.status === 'in-progress' || s.status === 'near-complete';
        if (filter === 'dc') return s.publisher === 'DC';
        if (filter === 'marvel') return s.publisher === 'Marvel';
        return true;
      }).sort((a, b) => a.name.localeCompare(b.name));

      if (loading) {
        return (
          <div className="p-8 text-center min-h-screen bg-gray-50">
            <div className="loader animate-spin w-8 h-8 border-4 border-blue-500 rounded-full mx-auto mb-4"></div>
            <p className="text-gray-500">Loading from Supabase...</p>
          </div>
        );
      }

      return (
        <div className="p-4 max-w-5xl mx-auto bg-gray-50 min-h-screen">
          {/* Header */}
          <div className="flex justify-between items-center mb-4">
            <div>
              <h1 className="text-2xl font-bold">Pedro's Comic Collection</h1>
              <p className="text-sm text-gray-500">Powered by Supabase</p>
            </div>
            <div className="flex gap-2">
              <button onClick={fetchData} className="px-3 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300">↻ Refresh</button>
              <button onClick={() => setShowAdmin(!showAdmin)} className={`px-3 py-1 rounded text-sm ${showAdmin ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>
                {showAdmin ? '✕ Close Admin' : '⚙ Admin'}
              </button>
            </div>
          </div>

          {/* Admin Panel */}
          {showAdmin && (
            <div className="bg-white rounded shadow p-4 mb-4 border-2 border-blue-200">
              <div className="flex gap-2 mb-4">
                <button onClick={() => setAdminMode('add-issue')} className={`px-3 py-1 rounded text-sm ${adminMode === 'add-issue' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>Add Issue</button>
                <button onClick={() => setAdminMode('add-series')} className={`px-3 py-1 rounded text-sm ${adminMode === 'add-series' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>Add Series</button>
                <button onClick={() => setAdminMode('mark-owned')} className={`px-3 py-1 rounded text-sm ${adminMode === 'mark-owned' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>Mark Owned</button>
              </div>

              {message && <div className="mb-4 p-2 bg-green-100 text-green-800 rounded text-sm">{message}</div>}

              {adminMode === 'add-issue' && (
                <form onSubmit={handleAddIssue} className="space-y-3">
                  <div className="grid grid-cols-2 gap-3">
                    <select value={newIssue.series_id} onChange={e => setNewIssue({...newIssue, series_id: e.target.value})} className="p-2 border rounded" required>
                      <option value="">Select Series</option>
                      {series.sort((a,b) => a.name.localeCompare(b.name)).map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                    </select>
                    <input type="text" placeholder="Issue # (e.g. #18)" value={newIssue.issue_number} onChange={e => setNewIssue({...newIssue, issue_number: e.target.value})} className="p-2 border rounded" required />
                  </div>
                  <input type="text" placeholder="Covers (comma separated)" value={newIssue.covers} onChange={e => setNewIssue({...newIssue, covers: e.target.value})} className="w-full p-2 border rounded" required />
                  <div className="grid grid-cols-2 gap-3">
                    <select value={newIssue.status} onChange={e => setNewIssue({...newIssue, status: e.target.value})} className="p-2 border rounded">
                      <option value="pending">Pending</option>
                      <option value="owned">Owned</option>
                      <option value="wishlist">Wishlist</option>
                    </select>
                    <input type="text" placeholder="Notes (optional)" value={newIssue.notes} onChange={e => setNewIssue({...newIssue, notes: e.target.value})} className="p-2 border rounded" />
                  </div>
                  <button type="submit" disabled={saving} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                    {saving ? 'Adding...' : 'Add Issue'}
                  </button>
                </form>
              )}

              {adminMode === 'add-series' && (
                <form onSubmit={handleAddSeries} className="space-y-3">
                  <input type="text" placeholder="Series Name" value={newSeries.name} onChange={e => setNewSeries({...newSeries, name: e.target.value})} className="w-full p-2 border rounded" required />
                  <div className="grid grid-cols-3 gap-3">
                    <select value={newSeries.publisher} onChange={e => setNewSeries({...newSeries, publisher: e.target.value})} className="p-2 border rounded">
                      <option value="DC">DC</option>
                      <option value="Marvel">Marvel</option>
                      <option value="Image">Image</option>
                      <option value="Dark Horse">Dark Horse</option>
                      <option value="Various">Various</option>
                    </select>
                    <select value={newSeries.status} onChange={e => setNewSeries({...newSeries, status: e.target.value})} className="p-2 border rounded">
                      <option value="in-progress">In Progress</option>
                      <option value="complete">Complete</option>
                      <option value="near-complete">Near Complete</option>
                      <option value="misc">Misc</option>
                    </select>
                    <input type="number" placeholder="Total Spent" value={newSeries.total_spent} onChange={e => setNewSeries({...newSeries, total_spent: e.target.value})} className="p-2 border rounded" />
                  </div>
                  <button type="submit" disabled={saving} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                    {saving ? 'Adding...' : 'Add Series'}
                  </button>
                </form>
              )}

              {adminMode === 'mark-owned' && (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  <p className="text-sm text-gray-500 mb-2">Click to mark pending items as owned:</p>
                  {issues.filter(i => i.status === 'pending').map(issue => {
                    const issueSeries = series.find(s => s.id === issue.series_id);
                    return (
                      <div key={issue.id} className="p-2 border rounded flex justify-between items-center hover:bg-gray-50">
                        <div>
                          <span className="font-medium">{issueSeries?.name}</span>
                          <span className="text-gray-500 ml-2">{issue.issue_number}</span>
                        </div>
                        <button onClick={() => markAsOwned(issue.id)} className="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                          ✓ Mark Owned
                        </button>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* Stats */}
          <div className="grid grid-cols-5 gap-3 mb-4">
            <div className="bg-white p-3 rounded shadow text-center">
              <div className="text-2xl font-bold text-green-600">${totalSpent.toLocaleString()}</div>
              <div className="text-xs text-gray-500">Invested</div>
            </div>
            <div className="bg-white p-3 rounded shadow text-center">
              <div className="text-2xl font-bold text-blue-600">{ownedBooks}</div>
              <div className="text-xs text-gray-500">Owned</div>
            </div>
            <div className="bg-white p-3 rounded shadow text-center">
              <div className="text-2xl font-bold text-yellow-600">{pendingBooks}</div>
              <div className="text-xs text-gray-500">Pending</div>
            </div>
            <div className="bg-white p-3 rounded shadow text-center">
              <div className="text-2xl font-bold text-purple-600">{completeRuns}</div>
              <div className="text-xs text-gray-500">Complete</div>
            </div>
            <div className="bg-white p-3 rounded shadow text-center">
              <div className="text-2xl font-bold text-red-600">{gaps.length}</div>
              <div className="text-xs text-gray-500">Gaps</div>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mb-4 border-b">
            {['overview', 'pending', 'gaps', 'gifts'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 font-medium ${activeTab === tab ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}`}>
                {tab.charAt(0).toUpperCase() + tab.slice(1)}
              </button>
            ))}
          </div>

          {/* Overview Tab */}
          {activeTab === 'overview' && (
            <div>
              <div className="flex gap-2 mb-4">
                {['all', 'complete', 'in-progress', 'dc', 'marvel'].map(f => (
                  <button key={f} onClick={() => setFilter(f)}
                    className={`px-3 py-1 rounded text-sm ${filter === f ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>
                    {f.charAt(0).toUpperCase() + f.slice(1)}
                  </button>
                ))}
              </div>
              <div className="space-y-2">
                {filteredSeries.map(s => {
                  const seriesIssues = getSeriesIssues(s.id);
                  const owned = seriesIssues.filter(i => i.status === 'owned').length;
                  const pending = seriesIssues.filter(i => i.status === 'pending').length;
                  return (
                    <div key={s.id} className="bg-white rounded shadow">
                      <div className="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50" onClick={() => toggleExpand(s.id)}>
                        <div className="flex items-center gap-3">
                          <span className="font-medium">{s.name}</span>
                          <StatusBadge status={s.status} />
                          <span className="text-xs text-gray-400">{s.publisher}</span>
                        </div>
                        <div className="flex items-center gap-4 text-sm">
                          <span className="text-green-600">{owned} owned</span>
                          {pending > 0 && <span className="text-yellow-600">{pending} pending</span>}
                          <span className="text-gray-500">${s.total_spent}</span>
                          <span className="text-gray-400">{expanded[s.id] ? '▼' : '▶'}</span>
                        </div>
                      </div>
                      {expanded[s.id] && (
                        <div className="px-3 pb-3 border-t">
                          {s.notes && <p className="text-sm text-gray-500 mt-2">{s.notes}</p>}
                          <div className="grid grid-cols-4 gap-2 mt-2">
                            {seriesIssues.map(issue => (
                              <div key={issue.id} className={`p-2 rounded text-xs ${issue.status === 'owned' ? 'bg-green-50' : 'bg-yellow-50'}`}>
                                <div className="font-medium flex justify-between">
                                  <span>{issue.issue_number}</span>
                                  {issue.is_key_issue && <span className="text-orange-500">★</span>}
                                </div>
                                <div className="text-gray-500 truncate">{issue.covers?.join(', ')}</div>
                                {issue.notes && <div className="text-orange-600 mt-1">{issue.notes}</div>}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Pending Tab */}
          {activeTab === 'pending' && (
            <div className="bg-white rounded shadow p-4">
              <h2 className="font-bold text-lg mb-3">Pending Items ({pendingBooks})</h2>
              <div className="space-y-2">
                {issues.filter(i => i.status === 'pending').map(issue => {
                  const issueSeries = series.find(s => s.id === issue.series_id);
                  return (
                    <div key={issue.id} className="p-2 border rounded flex justify-between items-center">
                      <div>
                        <span className="font-medium">{issueSeries?.name}</span>
                        <span className="text-gray-500 ml-2">{issue.issue_number}</span>
                      </div>
                      <div className="text-sm text-gray-500">{issue.covers?.join(', ')}</div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Gaps Tab */}
          {activeTab === 'gaps' && (
            <div className="bg-white rounded shadow p-4">
              <h2 className="font-bold text-lg mb-3">Collection Gaps ({gaps.length})</h2>
              <div className="space-y-2">
                {gaps.map(gap => {
                  const gapSeries = series.find(s => s.id === gap.series_id);
                  const pc = { high: 'border-l-red-500', medium: 'border-l-yellow-500', low: 'border-l-gray-300' };
                  return (
                    <div key={gap.id} className={`p-3 border-l-4 ${pc[gap.priority]} bg-gray-50 rounded`}>
                      <div className="flex justify-between">
                        <div>
                          <span className="font-medium">{gapSeries?.name}</span>
                          <span className="text-gray-500 ml-2">{gap.issue_number}</span>
                          <span className="text-gray-400 ml-2">({gap.cover_needed})</span>
                        </div>
                        <div className="text-green-600 font-medium">${gap.estimated_cost}</div>
                      </div>
                      {gap.notes && <p className="text-sm text-gray-500 mt-1">{gap.notes}</p>}
                    </div>
                  );
                })}
                <div className="mt-4 p-3 bg-blue-50 rounded">
                  <strong>Total to fill gaps:</strong> ${gaps.reduce((sum, g) => sum + (parseFloat(g.estimated_cost) || 0), 0)}
                </div>
              </div>
            </div>
          )}

          {/* Gifts Tab */}
          {activeTab === 'gifts' && (
            <div className="bg-white rounded shadow p-4">
              <h2 className="font-bold text-lg mb-3">Gift List</h2>
              {gifts.map(gift => (
                <div key={gift.id} className="p-3 border rounded flex justify-between items-center mb-2">
                  <div>
                    <div className="font-medium">{gift.item_description}</div>
                    <div className="text-sm text-gray-500">For: {gift.recipient}</div>
                  </div>
                  <StatusBadge status={gift.status} />
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
